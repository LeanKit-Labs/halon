/**
 * halon - JavaScript Hypermedia Client
 * Author: LeanKit
 * Version: v0.4.0
 * Url: https://github.com/LeanKit-Labs/halon
 * License(s): MIT Copyright (c) 2015 LeanKit
 */
(function(e,t){if("function"==typeof define&&define.amd)define(["machina","lodash","when","urijs","urijs/src/URITemplate"],t);else{if("object"!=typeof module||!module.exports)throw new Error("Sorry - halon only supports AMD or CommonJS module environments.");module.exports=t(require("machina"),require("lodash"),require("when"),require("urijs"),require("urijs/src/URITemplate"))}})(this,function(e,t,n,r,i){function o(e,t){this.name="LinkMissingError",this.message=e,this.link=t,this.stack=(new Error).stack}function s(e,n){var i=r.expand(e.href,n).href(),o=n["?"];return o?(i=i+"?"+t.map(o,function(e,t){return t+"="+r.encode(e)}).join("&"),delete n["?"]):e.parameters&&(i=i+"?"+t.compact(t.map(e.parameters,function(e,t){return n[t]?t+"="+r.encode(n[t]):void 0})).join("&")),i}function a(e,t,r,i){return r=r||{},i=i||{},n.promise(function(n,o){e.handle("invoke.resource",this,t,r,i,n,o)}.bind(this))}function d(e,n){if(t.isEmpty(e)||t.isString(e))return e;if(e._links)return c(u(e,n));var r=Object.keys(e).filter(function(e){return"_origin"!==e})[0],i={_origin:e._origin};return i[r]=t.map(e[r],function(e){return c(u(e,n))}),i}function c(e){return e._embedded&&(t.each(e._embedded,function(t,n){c(t),e[n]=t}),delete e._embedded),e}function u(e,n){var r=e;return t.each(e._links,function(t,i){var o=i.split(":"),s=i,d=r;2===o.length&&(d=r[o[0]]=r[o[0]]||{},s=o[1]),d[s]=a.bind(e,n,i)}),e}function f(e){var n=t.reduce(e,function(e,t,n){return t.forEach(function(t){e._links[n+":"+t]=void 0}),e},{_links:{}});return n}var h;o.prototype=Object.create(Error.prototype),o.prototype.constructor=o;var l=e.Fsm.extend({initialize:function(e){t.extend(this.client,u(f(e.knownOptions),this))},followResourceLink:function(e,t,n,r){return a.call(e,this,t,n,r)},states:{uninitialized:{connect:"initializing","invoke.resource":function(){this.deferUntilTransition("ready")}},initializing:{_onEnter:function(){this.adapter({href:this.root,method:"OPTIONS"},{headers:this.getHeaders(),server:this.server}).then(this.handle.bind(this,"root.loaded"),function(e){console.warn(e),this.connectionError=e,this.transition("connection.failed")}.bind(this))},"root.loaded":function(e){t.merge(this.client,u(e,this)),this.transition("ready")},"invoke.resource":function(){this.deferUntilTransition("ready")}},ready:{_onEnter:function(){this.client.deferred&&(this.client.deferred.resolve(this.client),this.client.deferred=void 0)},"invoke.resource":function(e,n,r,i,a,c){var u=e._links[n];return u?((u.templated||u.parameters||r["?"])&&(u=t.extend({},u,{href:s(u,r)})),r.body&&(r=r.body),void this.adapter(u,{data:r,headers:this.getHeaders(i),server:this.server}).then(function(e){return d(e,this)}.bind(this)).then(a,c)):c(new o("No link definition for rel '"+n+"'",n))}},"connection.failed":{_onEnter:function(){this.client.deferred&&(this.client.deferred.reject(this.connectionError),this.client.deferred=void 0)},connect:"initializing","invoke.resource":function(e,t,n,r,i,o){o(this.connectionError)}}},getHeaders:function(e){return t.extend({},this.headers,e||{},{Accept:"application/hal.v"+this.version+"+json"})}}),p=function(e){var r={version:1,knownOptions:{},adapter:h,headers:{}},i=function(){var e=Array.prototype.slice.call(arguments,0);return n.all(e)};e=t.defaults(e,r);var o=/http(s)?[:][\/]{2}[^\/]*/.exec(e.root);e.server=o?o[0]:void 0,e.client=i;var s=i.fsm=new l(e),a=function(e,t,n){s.state===e&&t(i);var r;r=s.on("transition",function(o){process.nextTick(function(){o.toState===e&&(n||r.off(),t(i,s.connectionError,r))})})};return i.followResourceLink=i.fsm.followResourceLink.bind(i.fsm),i.on=function(e,t,n){if("ready"===e)a("ready",t,n);else{if("rejected"!==e)throw new Error("Only 'ready' and 'rejected' events are supported by this emitter.");a("connection.failed",t,n)}return i},i.connect=function(){var e=this.deferred&&"fulfilled"!==this.deferred.promise.inspect().state;return e||(this.deferred=n.defer(),s.handle("connect")),this.deferred.promise},e.start&&setTimeout(function(){i.connect()["catch"](function(){})},0),i};return p.defaultAdapter=function(e){return h=e,p},p.jQueryAdapter=function(e){var r=["PATCH","POST","PUT"];return function(i,o){var s=i.href.indexOf(o.server)<0?o.server+i.href:i.href,a={url:s,type:i.method,headers:o.headers,dataType:"json",data:o.data};return o.data&&t.contains(r,i.method.toUpperCase())&&(a.data="string"==typeof o.data?o.data:JSON.stringify(o.data),a.contentType="application/json"),n.promise(function(t,n){e.ajax(a).then(t,function(e,t,r){var i=new Error(r);i.status=e.status,n(i)})})}},p.requestAdapter=function(e){return function(r,i){var o;i.data&&i.data.formData&&(o=i.data.formData,delete i.data.formData);var s=t.isString(i.data)?JSON.parse(i.data):i.data,a=r.href.indexOf(i.server)<0?i.server+r.href:r.href,d={url:a,method:r.method,headers:i.headers};return o?d.formData=o:s&&!t.isEmpty(s)&&(d.json=s,d.headers["Content-Type"]="application/json"),n.promise(function(t,n){e(d,function(e,r,i){var o;if(i&&"{"===i[0]){var s=i&&""!==i&&"{}"!==i;o=s?JSON.parse(i):{},o._status=r.statusCode}else i&&(i._status=r.statusCode);e?n(e):r.statusCode>=400?n(o||i):t(o||i)})})}},p.LinkMissingError=o,p});