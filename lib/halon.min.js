/**
 * halon - JavaScript Hypermedia Client
 * Author: LeanKit
 * Version: v0.0.2
 * Url: https://github.com/LeanKit-Labs/halon
 * License(s): MIT Copyright (c) 2014 LeanKit
 */
(function(e,n){if("function"==typeof define&&define.amd)define(["machina","lodash","when","URIjs","URITemplate"],n);else{if("object"!=typeof module||!module.exports)throw new Error("Sorry - halon only supports AMD or CommonJS module environments.");module.exports=n(require("machina"),require("lodash"),require("when"),require("URIjs"),require("URIjs/src/URITemplate"))}})(this,function(e,n,t,r){function i(e,t){var i=r.expand(e.href,t).href(),o=t["?"];return o?(i=i+"?"+n.map(o,function(e,n){return n+"="+r.encode(e)}).join("&"),delete t["?"]):e.parameters&&(i=i+"?"+n.compact(n.map(e.parameters,function(e,n){return t[n]?n+"="+r.encode(t[n]):void 0})).join("&")),i}function o(e,n,r,i){return r=r||{},i=i||{},t.promise(function(t,o){e.handle("invoke.resource",this,n,r,i,t,o)}.bind(this))}function a(e,t){if(n.isEmpty(e)||n.isString(e))return e;if(e._links)return s(d(e,t));var r=Object.keys(e).filter(function(e){return"_origin"!==e})[0],i={_origin:e._origin};return i[r]=n.map(e[r],function(e){return s(d(e,t))}),i}function s(e){return e._embedded&&(n.each(e._embedded,function(n,t){s(n),e[t]=n}),delete e._embedded),e}function d(e,t){var r=e;return n.each(e._links,function(n,i){var a=i.split(":"),s=i,d=r;2===a.length&&(d=r[a[0]]=r[a[0]]||{},s=a[1]),d[s]=o.bind(e,t,i)}),e}function u(e){var t=n.reduce(e,function(e,n,t){return n.forEach(function(n){e._links[t+":"+n]=void 0}),e},{_links:{}});return t}var c,f=e.Fsm.extend({initialize:function(e){n.extend(this.client,d(u(e.knownOptions),this))},states:{uninitialized:{start:"initializing","invoke.resource":function(){this.deferUntilTransition("ready")}},initializing:{_onEnter:function(){this.adapter({href:this.root,method:"OPTIONS"},{headers:this.getHeaders(),server:this.server}).then(this.handle.bind(this,"root.loaded"),function(e){console.warn(e),this.connectionError=e,this.transition("connection.failed")}.bind(this))},"root.loaded":function(e){n.merge(this.client,d(e,this)),this.transition("ready")},"invoke.resource":function(){this.deferUntilTransition("ready")}},ready:{"invoke.resource":function(e,t,r,o,s,d){var u=e._links[t];if(!u)throw new Error("No link definition for rel '"+t+"'");(u.templated||u.parameters||r["?"])&&(u=n.extend({},u,{href:i(u,r)})),r.body&&(r=r.body),this.adapter(u,{data:r,headers:this.getHeaders(o),server:this.server}).then(function(e){return a(e,this)}.bind(this)).then(s,d)}},"connection.failed":{start:"initializing","invoke.resource":function(e,n,t,r,i,o){o(this.connectionError)}}},getHeaders:function(e){return n.extend({},this.headers,e||{},{Accept:"application/hal.v"+this.version+"+json"})}}),h=function(e){var r={version:1,knownOptions:{},adapter:c,headers:{}},i=function(){var e=Array.prototype.slice.call(arguments,0);return t.all(e)};e=n.defaults(e,r);var o=/http(s)?[:][\/]{2}[^\/]*/.exec(e.root);e.server=o?o[0]:void 0,e.client=i;var a=i.fsm=new f(e),s=function(e,n,t){a.state===e&&n(i);var r;r=a.on("transition",function(o){o.toState===e&&(t||r.off(),n(i,a.connectionError,r))})};return i.onReady=function(e){return s("ready",e),i},i.onRejected=function(e,n){return s("connection.failed",e,n),i},i.start=function(){return a.handle("start"),i},e.doNotStart||setTimeout(function(){i.start()},0),i};return h.defaultAdapter=function(e){return c=e,h},h.jQueryAdapter=function(e){return function(n,t){return e.ajax({url:n.href,type:n.method,headers:t.headers,dataType:"json",data:t.data})}},h.requestAdapter=function(e){return function(r,i){var o;i.data&&i.data.formData&&(o=i.data.formData,delete i.data.formData);var a=n.isString(i.data)?JSON.parse(i.data):i.data,s=r.href.indexOf(i.server)<0?i.server+r.href:r.href,d={url:s,method:r.method,headers:i.headers};return o?d.formData=o:a&&!n.isEmpty(a)&&(d.json=a,d.headers["Content-Type"]="application/json"),t.promise(function(n,t){e(d,function(e,r,i){if(e)t(e);else if(i&&"{"===i[0]){var o=i&&""!==i&&"{}"!==i,a=o?JSON.parse(i):{};n(a)}else n(i)})})}},h});