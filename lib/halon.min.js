/**
 * halon - JavaScript Hypermedia Client
 * Author: LeanKit
 * Version: v0.0.2
 * Url: https://github.com/LeanKit-Labs/halon
 * License(s): MIT Copyright (c) 2014 LeanKit
 */
(function(e,n){if("function"==typeof define&&define.amd)define(["machina","lodash","when","URIjs","URITemplate"],n);else{if("object"!=typeof module||!module.exports)throw new Error("Sorry - halon only supports AMD or CommonJS module environments.");module.exports=n(require("machina"),require("lodash"),require("when"),require("URIjs"),require("URIjs/src/URITemplate"))}})(this,function(e,n,t,r){function i(e){return n.each(Array.prototype.slice.call(arguments,1),function(t){n.each(t,function(n,t){"object"==typeof n?(e[t]=e[t]||{},i(e[t],n)):e[t]=n})}),e}function o(e,n,r,i){return r=r||{},i=i||{},t.promise(function(t,o){e.handle("invoke.resource",this,n,r,i,t,o)}.bind(this))}function a(e,t){if(e._links)return s(u(e,t));var r=Object.keys(e).filter(function(e){return"_origin"!==e})[0];return n.map(e[r],function(e){return s(u(e,t))})}function s(e){return e._embedded&&(n.each(e._embedded,function(n,t){s(n),e[t]=n}),delete e._embedded),e}function u(e,t){var r=e._actions={};return n.each(e._links,function(n,i){var a=i.split(":"),s=i,u=r;2===a.length&&(u=r[a[0]]=r[a[0]]||{},s=a[1]),u[s]=o.bind(e,t,i)}),e}function d(e){var t=n.reduce(e,function(e,n,t){return n.forEach(function(n){e._links[t+":"+n]={}}),e},{_links:{}});return t}var f,c=e.Fsm.extend({initialize:function(e){n.extend(this.client,u(d(e.knownOptions),this))},states:{uninitialized:{start:"initializing","invoke.resource":function(){this.deferUntilTransition("ready")}},initializing:{_onEnter:function(){this.adapter({href:this.root,method:"OPTIONS"},{headers:this.getHeaders(),server:this.server}).then(this.handle.bind(this,"root.loaded"),function(e){console.warn(e)})},"root.loaded":function(e){i(this.client,u(e,this)),this.transition("ready")},"invoke.resource":function(){this.deferUntilTransition("ready")}},ready:{"invoke.resource":function(e,i,o,s,u,d){var f=e._links[i];if(!f)throw new Error("No link definition for rel '"+i+"'");f.templated&&(f=n.extend({},f,{href:r.expand(f.href,o).href()})),this.adapter(f,{data:o,headers:this.getHeaders(s),server:this.server}).then(function(e){return t.promise(function(n,t){if(!e){var r=new Error("Empty response for "+i);r.resourceDef=f,t(r)}n(a(e,this))}.bind(this))}.bind(this)).then(u,d)}}},getHeaders:function(e){return n.extend({},this.headers,e||{},{Accept:"application/hal.v"+this.version+"+json"})}}),h={version:1,knownOptions:{},adapter:f,headers:{}},l=function(e){var r=function(){var e=Array.prototype.slice.call(arguments,0);return t.all(e)};e=n.defaults(e,h),e.server=/http(s)?[:][\/]{2}[^\/]*/.exec(e.root)[0],e.client=r;var i=r.fsm=new c(e);return r.onReady=function(e){if("ready"===i.state)e(r);else{var n;n=i.on("transition",function(t){"ready"===t.toState&&(n.off(),e(r))}.bind(this))}return r},r.start=function(){i.handle("start")},e.doNotStart||setTimeout(function(){r.start()},0),r};return l.defaultAdapter=function(e){return f=e,l},l.jQueryAdapter=function(e){return function(n,t){return e.ajax({url:n.href,type:n.method,headers:t.headers,dataType:"json",data:t.data})}},l.requestAdapter=function(e){return function(r,i){var o=n.isString(i.data)?i.data:JSON.stringify(i.data),a=r.href.indexOf(i.server)<0?i.server+r.href:r.href;return t.promise(function(n,t){e({url:a,method:r.method,headers:i.headers,body:o},function(e,r,i){e?t(e):n(JSON.parse(i))})})}},l});