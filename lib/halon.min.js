/**
 * halon - JavaScript Hypermedia Client
 * Author: LeanKit
 * Version: v0.0.1
 * Url: https://github.com/LeanKit-Labs/halon
 * License(s): MIT Copyright (c) 2014 LeanKit
 */
(function(e,n){if("function"==typeof define&&define.amd)define(["machina","lodash","when","URIjs","URITemplate"],n);else{if("object"!=typeof module||!module.exports)throw new Error("Sorry - halon only supports AMD or CommonJS module environments.");module.exports=n(require("machina"),require("lodash"),require("when"),require("URIjs"),require("URIjs/src/URITemplate"))}})(this,function(e,n,t,i){function r(e){return n.each(Array.prototype.slice.call(arguments,1),function(t){n.each(t,function(n,t){"object"==typeof n?(e[t]=e[t]||{},r(e[t],n)):e[t]=n})}),e}function o(e,n,i){return i=i||{},t.promise(function(t,r){e.handle("invoke.resource",this,n,i,t,r)}.bind(this))}function a(e){return e._embedded&&(n.each(e._embedded,function(n,t){a(n),e[t]=n}),delete e._embedded),e}function s(e,t){var i=e._actions={};return n.each(e._links,function(n,r){var a=r.split(":"),s=r,u=i;2===a.length&&(u=i[a[0]]=i[a[0]]||{},s=a[1]),u[s]=o.bind(e,t,r)}),e}function u(e){var t=n.reduce(e,function(e,n,t){return n.forEach(function(n){e._links[t+":"+n]={}}),e},{_links:{}});return t}var d,c=e.Fsm.extend({initialize:function(e){n.extend(this.client,s(u(e.knownOptions),this))},states:{uninitialized:{start:"initializing","invoke.resource":function(){this.deferUntilTransition("ready")}},initializing:{_onEnter:function(){this.adapter({href:this.root,method:"OPTIONS"},{headers:{Accept:"application/hal.v"+this.version+"+json"}}).then(this.handle.bind(this,"root.loaded"),function(e){console.warn(e)})},"root.loaded":function(e){r(this.client,s(e,this)),this.transition("ready")},"invoke.resource":function(){this.deferUntilTransition("ready")}},ready:{"invoke.resource":function(e,r,o,u,d){var c=e._links[r];if(!c)throw new Error("No link definition for rel '"+r+"'");c.templated&&(c=n.extend({},c,{href:i.expand(c.href,o).href()})),this.adapter(c,{data:o,headers:{Accept:"application/hal.v"+this.version+"+json"}}).then(function(e){return t.promise(function(n,t){if(!e){var i=new Error("Empty response for "+r);i.resourceDef=c,t(i)}n(a(s(e,this)))}.bind(this))}.bind(this)).then(u,d)}}}}),f={version:1,knownOptions:{},adapter:d},h=function(e){var i=function(){var e=Array.prototype.slice.call(arguments,0);return t.all(e)};e=n.defaults(e,f),e.client=i;var r=i.fsm=new c(e);return i.onReady=function(e){if("ready"===r.state)e(i);else{var n;n=r.on("transition",function(t){"ready"===t.toState&&(n.off(),e(i))}.bind(this))}return i},i.start=function(){r.handle("start")},e.doNotStart||setTimeout(function(){i.start()},0),i};return h.defaultAdapter=function(e){return d=e,h},h.jQueryAdapter=function(e){return function(n,t){return e.ajax({url:n.href,type:n.method,headers:t.headers,dataType:"json",data:t.data})}},h});